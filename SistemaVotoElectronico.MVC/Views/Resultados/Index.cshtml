@model SistemaVoto.Modelos.ResumenGeneral

@{
    ViewData["Title"] = "Resultados Electorales";
}

<style>
    .nav-pills .nav-link.active {
        background-color: #0d6efd;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .nav-pills .nav-link {
        color: #495057;
        background-color: #e9ecef;
        margin-right: 10px;
        border-radius: 20px;
        padding: 10px 20px;
        transition: all 0.3s ease;
    }

        .nav-pills .nav-link:hover {
            background-color: #dee2e6;
        }
    /* Ocultar el botón de General al inicio para no confundir, o dejarlo al final */
</style>

<div class="container mt-4">

    <div class="card shadow-sm mb-4 border-primary">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">🔍 Filtrar Resultados</h5>
            <a asp-controller="Home" asp-action="Index" class="btn btn-sm btn-light">🏠 Volver</a>
        </div>
        <div class="card-body bg-light">
            <form method="get" asp-action="Index" id="formFiltro" class="row g-3 align-items-end">
                <input type="hidden" name="procesoId" value="@ViewBag.ProcesoId" />

                <div class="col-md-3">
                    <label class="form-label fw-bold">Provincia:</label>
                    <select id="provinciaId" name="provinciaId" class="form-select" asp-items="ViewBag.Provincias">
                        <option value="">-- Todas --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Cantón:</label>
                    <select id="cantonId" name="cantonId" class="form-select" disabled>
                        <option value="">-- Todos --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Parroquia:</label>
                    <select id="parroquiaId" name="parroquiaId" class="form-select" disabled>
                        <option value="">-- Todas --</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex gap-2">
                    <button type="submit" class="btn btn-primary w-100">🔎 Filtrar</button>
                    <a href="@Url.Action("Index", new { procesoId = ViewBag.ProcesoId })" class="btn btn-outline-secondary">Limpiar</a>
                </div>
            </form>
        </div>
    </div>

    <div class="text-end mb-3">
        <button onclick="generarPDF()" class="btn btn-danger shadow-sm">
            📄 Descargar Reporte PDF
        </button>
    </div>

    <div id="area-impresion" class="p-4 bg-white border rounded shadow">

        <h2 class="text-center text-primary fw-bold mb-3">📊 @(ViewBag.NombreProceso ?? "Resultados Electorales")</h2>

        @if (Model == null || Model.Resultados.Count == 0)
        {
            <div class="alert alert-warning text-center">
                ⚠️ No hay votos registrados con estos filtros.
            </div>
        }
        else
        {
            <div class="alert alert-info text-center mb-4">
                <strong>Total Votos:</strong> @Model.TotalVotos |
                <strong>Estado:</strong> @Model.Estado
            </div>

            <ul class="nav nav-pills justify-content-center mb-4" id="pills-tab" role="tablist">
                @{
                    // 1. ORDEN FORZADO: Presidente primero
                    var ordenPrioridad = new List<string> {
                        "Presidente", "Vicepresidente", "Asambleísta Nacional", "Asambleísta Provincial", "Alcalde", "Prefecto"
                        };

                    // 2. Agrupamos y ordenamos usando la lista de prioridad
                    var grupos = Model.Resultados
                    .GroupBy(x => x.Dignidad)
                    .OrderBy(g =>
                    {
                        var key = g.Key ?? "Otros";
                        // Busca el índice en la lista de prioridades
                        var index = ordenPrioridad.FindIndex(p => key.Contains(p, StringComparison.OrdinalIgnoreCase));
                        // Si no está en la lista, lo manda al final (999)
                        return index == -1 ? 999 : index;
                    })
                    .ThenBy(g => g.Key)
                    .ToList();

                    bool esPrimero = true;
                }

                @foreach (var grupo in grupos)
                {
                    var nombreDignidad = grupo.Key ?? "Otros";
                    var idTab = "tab-" + nombreDignidad.Replace(" ", "");
                    var idTarget = "content-" + nombreDignidad.Replace(" ", "");
                    // Activa SOLO el primero (Presidente)
                    var claseActive = esPrimero ? "active" : "";

                    <li class="nav-item" role="presentation">
                        <button class="nav-link @claseActive" id="@idTab" data-bs-toggle="pill" data-bs-target="#@idTarget" type="button" role="tab">
                            🏛️ @nombreDignidad
                        </button>
                    </li>
                    esPrimero = false;
                }

                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-general" data-bs-toggle="pill" data-bs-target="#content-general" type="button" role="tab">
                        🌍 Resumen Global
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="pills-tabContent">

                @{
                    esPrimero = true;
                }
                @foreach (var grupo in grupos)
                {
                    var nombreDignidad = grupo.Key ?? "Otros";
                    var idTarget = "content-" + nombreDignidad.Replace(" ", "");
                    var idCanvas = "chart-" + nombreDignidad.Replace(" ", "");
                    // Activa el contenido del primero
                    var claseActive = esPrimero ? "show active" : "";

                    <div class="tab-pane fade @claseActive" id="@idTarget" role="tabpanel">
                        <div class="row align-items-center">
                            <div class="col-md-5">
                                <canvas id="@idCanvas"></canvas>
                            </div>
                            <div class="col-md-7">
                                <table class="table table-hover align-middle mt-3">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Candidato</th>
                                            <th>Lista</th>
                                            <th>Votos</th>
                                            <th>%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @{
                                            int totalGrupo = grupo.Sum(x => x.CantidadVotos);
                                        }
                                        @foreach (var item in grupo.OrderByDescending(x => x.CantidadVotos))
                                        {
                                            double porcentaje = totalGrupo > 0 ? (double)item.CantidadVotos / totalGrupo * 100 : 0;
                                            var esGanador = item == grupo.OrderByDescending(x => x.CantidadVotos).First() && item.CantidadVotos > 0;

                                            <tr class="@(esGanador ? "table-success" : "")">
                                                <td class="fw-bold">
                                                    @if (!string.IsNullOrEmpty(item.FotoUrl))
                                                    {
                                                        <img src="@item.FotoUrl" class="rounded-circle me-2 border" width="40" height="40" style="object-fit:cover" />
                                                    }
                                                    @item.Candidato
                                                    @if (esGanador)
                                                    {
                                                        <span class="badge bg-warning text-dark ms-1">🏆</span>
                                                    }
                                                </td>
                                                <td><span class="badge bg-secondary">@item.Partido</span></td>
                                                <td class="fs-5">@item.CantidadVotos</td>
                                                <td style="width: 30%;">
                                                    <div class="progress" style="height: 25px;">
                                                        <div class="progress-bar @(esGanador ? "bg-success" : "bg-primary")"
                                                             role="progressbar" style="width: @porcentaje.ToString("0")%;">
                                                            @porcentaje.ToString("0.0")%
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    esPrimero = false;
                }

                <div class="tab-pane fade" id="content-general" role="tabpanel">
                    <h4 class="text-center mb-4 text-muted">Resumen de todas las dignidades</h4>
                    <div class="row">
                        @foreach (var grupo in grupos)
                        {
                            var nombreDignidad = grupo.Key ?? "Otros";
                            <div class="col-md-6 mb-4">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-header text-center fw-bold bg-light">@nombreDignidad</div>
                                    <div class="card-body">
                                        <canvas id="mini-chart-@nombreDignidad.Replace(" ", "")"></canvas>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

            </div>
        }
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="~/lib/jquery/dist/jquery.min.js"></script>

<script>
    var selProv = '@ViewBag.ProvinciaId';
    var selCant = '@ViewBag.CantonId';
    var selParr = '@ViewBag.ParroquiaId';

    $(document).ready(function () {
        if (selProv) cargarCantones(selProv, selCant);

        $("#provinciaId").change(function () {
            var id = $(this).val();
            $("#cantonId").empty().append('<option value="">-- Todos --</option>').prop('disabled', true);
            $("#parroquiaId").empty().append('<option value="">-- Todas --</option>').prop('disabled', true);
            if (id) cargarCantones(id, null);
        });

        $("#cantonId").change(function () {
            var id = $(this).val();
            $("#parroquiaId").empty().append('<option value="">-- Todas --</option>').prop('disabled', true);
            if (id) cargarParroquias(id, null);
        });

        inicializarGraficasAgrupadas();
    });

    function cargarCantones(provId, valorSeleccionado) {
        $.getJSON('/Geografia/ObtenerCantones?provinciaId=' + provId, function (data) {
            var combo = $("#cantonId");
            combo.empty().append('<option value="">-- Todos --</option>');
            $.each(data, function (i, item) {
                combo.append($('<option>').val(item.id).text(item.nombre));
            });
            combo.prop('disabled', false);
            if (valorSeleccionado) {
                combo.val(valorSeleccionado);
                cargarParroquias(valorSeleccionado, selParr);
            }
        });
    }

    function cargarParroquias(cantId, valorSeleccionado) {
        $.getJSON('/Geografia/ObtenerParroquias?cantonId=' + cantId, function (data) {
            var combo = $("#parroquiaId");
            combo.empty().append('<option value="">-- Todas --</option>');
            $.each(data, function (i, item) {
                combo.append($('<option>').val(item.id).text(item.nombre));
            });
            combo.prop('disabled', false);
            if (valorSeleccionado) combo.val(valorSeleccionado);
        });
    }

    function generarPDF() {
        var element = document.getElementById('area-impresion');
        // Para imprimir TODO, mostramos temporalmente todas las pestañas
        // Pero html2pdf captura lo que se ve. Una opción rápida es forzar la visualización
        // o dejar que el usuario imprima la vista actual. Por simplicidad, imprime la vista actual.
        var opt = {
            margin: 0.3,
            filename: 'Reporte_Electoral_2026.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
        };
        html2pdf().set(opt).from(element).save();
    }

    // --- GRÁFICAS INTELIGENTES (Agrupación de Listas) ---
    function inicializarGraficasAgrupadas() {
        var datos = @Html.Raw(Json.Serialize(Model?.Resultados));
        if (!datos) return;

        var gruposDignidad = {};
        datos.forEach(d => {
            var k = d.dignidad || "Otros"; // Asegura que no sea null
            if (!gruposDignidad[k]) gruposDignidad[k] = [];
            gruposDignidad[k].push(d);
        });

        var colores = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#343a40', '#dc3545'];

        for (const [dignidad, candidatos] of Object.entries(gruposDignidad)) {
            var keyLimpia = dignidad.replace(/ /g, "");

            // Lógica para agrupar votos por PARTIDO/LISTA
            var votosPorPartido = {};
            candidatos.forEach(c => {
                var nombrePartido = c.partido || "Independiente";
                if (!votosPorPartido[nombrePartido]) {
                    votosPorPartido[nombrePartido] = 0;
                }
                votosPorPartido[nombrePartido] += c.cantidadVotos;
            });

            var etiquetasChart = Object.keys(votosPorPartido);
            var datosChart = Object.values(votosPorPartido);

            // Crear Chart Principal (Doughnut)
            crearChart("chart-" + keyLimpia, etiquetasChart, datosChart, 'doughnut', true);

            // Crear Chart Mini (Pie) para el Resumen
            crearChart("mini-chart-" + keyLimpia, etiquetasChart, datosChart, 'pie', false);
        }

        function crearChart(canvasId, labels, data, tipo, mostrarLeyenda) {
            var ctx = document.getElementById(canvasId);
            if (ctx) {
                new Chart(ctx, {
                    type: tipo,
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colores,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: mostrarLeyenda, position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        var label = context.label || '';
                                        var value = context.raw || 0;
                                        var total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        var percentage = total > 0 ? Math.round((value / total) * 100) + '%' : '0%';
                                        return label + ': ' + value + ' votos (' + percentage + ')';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
    }
</script>