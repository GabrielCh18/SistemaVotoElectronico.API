@model SistemaVoto.Modelos.ResumenGeneral

@{
    ViewData["Title"] = "Resultados Electorales";
}

<style>
    /* Estilos para pestañas y visualización */
    .nav-pills .nav-link {
        color: #555;
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        margin: 0 5px;
        border-radius: 50px;
        padding: 10px 25px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
            transform: translateY(-2px);
        }

    .candidate-img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border: 2px solid #eee;
    }
</style>

<div class="container mt-4">

    <div class="card shadow-sm mb-4 border-0">
        <div class="card-header bg-white border-bottom pb-0">
            <h5 class="text-primary fw-bold"><i class="fa-solid fa-filter"></i> Filtrar Resultados</h5>
        </div>
        <div class="card-body bg-light">
            <form method="get" asp-action="Index" id="formFiltro" class="row g-3 align-items-end">
                <input type="hidden" name="procesoId" value="@ViewBag.ProcesoId" />

                <div class="col-md-3">
                    <label class="form-label fw-bold small text-muted">Provincia</label>
                    <select id="provinciaId" name="provinciaId" class="form-select form-select-sm" asp-items="ViewBag.Provincias">
                        <option value="">-- Todas --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold small text-muted">Cantón</label>
                    <select id="cantonId" name="cantonId" class="form-select form-select-sm" disabled>
                        <option value="">-- Todos --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold small text-muted">Parroquia</label>
                    <select id="parroquiaId" name="parroquiaId" class="form-select form-select-sm" disabled>
                        <option value="">-- Todas --</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex gap-2">
                    <button type="submit" class="btn btn-primary btn-sm w-100 fw-bold">🔎 Ver Resultados</button>
                    <a href="@Url.Action("Index", new { procesoId = ViewBag.ProcesoId })" class="btn btn-outline-secondary btn-sm" title="Limpiar Filtros">🔄</a>
                </div>
            </form>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark mb-0">
            📊 @(ViewBag.NombreProceso ?? "Resultados Electorales")
        </h2>
        <button onclick="generarPDF()" class="btn btn-danger btn-sm shadow-sm">
            <i class="fa-solid fa-file-pdf"></i> Descargar PDF
        </button>
    </div>

    <div id="area-impresion">

        @if (Model == null || Model.Resultados.Count == 0)
        {
            <div class="alert alert-warning text-center p-5 rounded-3 shadow-sm">
                <h4>⚠️ No hay datos disponibles</h4>
                <p>No se encontraron votos con los filtros seleccionados.</p>
            </div>
        }
        else
        {
            <div class="row text-center mb-4">
                <div class="col-md-3">
                    <div class="p-3 bg-white rounded shadow-sm border-start border-5 border-primary">
                        <small class="text-muted text-uppercase fw-bold">Votos Registrados</small>
                        <h4 class="mb-0 fw-bold text-primary">@Model.TotalVotos.ToString("N0")</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-3 bg-white rounded shadow-sm border-start border-5 border-secondary">
                        <small class="text-muted text-uppercase fw-bold">Ausentismo (No Votaron)</small>
                        <h4 class="mb-0 fw-bold text-secondary">@Model.Ausentismo.ToString("N0")</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-3 bg-white rounded shadow-sm border-start border-5 border-dark">
                        <small class="text-muted text-uppercase fw-bold">Total Padrón</small>
                        <h4 class="mb-0 fw-bold text-dark">@Model.TotalEmpadronados.ToString("N0")</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-3 bg-white rounded shadow-sm border-start border-5 border-success">
                        <small class="text-muted text-uppercase fw-bold">Estado</small>
                        <h4 class="mb-0 fw-bold text-success">@Model.Estado</h4>
                    </div>
                </div>
            </div>

            // Ordenamiento de pestañas
            var ordenPrioridad = new List<string> { "Presidente", "Vicepresidente", "Asambleísta Nacional", "Asambleísta Provincial", "Alcalde", "Prefecto" };

            var grupos = Model.Resultados
            .GroupBy(x => x.Dignidad)
            .OrderBy(g =>
            {
                var key = g.Key ?? "Otros";
                var index = ordenPrioridad.FindIndex(p => key.Contains(p, StringComparison.OrdinalIgnoreCase));
                return index == -1 ? 999 : index;
            })
            .ThenBy(g => g.Key)
            .ToList();

            bool esPrimero = true;

            <ul class="nav nav-pills justify-content-center mb-4" id="pills-tab" role="tablist">
                @foreach (var grupo in grupos)
                {
                    var nombreDignidad = grupo.Key ?? "Otros";
                    var idTab = "tab-" + nombreDignidad.Replace(" ", "");
                    var idTarget = "content-" + nombreDignidad.Replace(" ", "");
                    var claseActive = esPrimero ? "active" : "";

                    <li class="nav-item" role="presentation">
                        <button class="nav-link @claseActive shadow-sm" id="@idTab" data-bs-toggle="pill" data-bs-target="#@idTarget" type="button" role="tab">
                            @nombreDignidad
                        </button>
                    </li>
                    esPrimero = false;
                }

                <li class="nav-item" role="presentation">
                    <button class="nav-link shadow-sm border-warning text-dark" id="tab-general" data-bs-toggle="pill" data-bs-target="#content-general" type="button" role="tab">
                        🌍 Resumen Global
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="pills-tabContent">

                @{
                    esPrimero = true;
                }

                @foreach (var grupo in grupos)
                {
                    var nombreDignidad = grupo.Key ?? "Otros";
                    var idTarget = "content-" + nombreDignidad.Replace(" ", "");
                    var idCanvas = "chart-" + nombreDignidad.Replace(" ", "");
                    var claseActive = esPrimero ? "show active" : "";
                    int totalGrupo = grupo.Sum(x => x.CantidadVotos);

                    <div class="tab-pane fade @claseActive" id="@idTarget" role="tabpanel">
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-transparent text-center border-0 pt-4">
                                <h4 class="fw-bold text-primary">Resultados: @nombreDignidad</h4>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-center">

                                    <div class="col-lg-5 col-md-12 mb-4">
                                        <div class="position-relative" style="height:350px; width:100%;">
                                            <canvas id="@idCanvas"></canvas>
                                        </div>
                                    </div>

                                    <div class="col-lg-7 col-md-12">
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Candidato</th>
                                                        <th>Partido / Lista</th>
                                                        <th class="text-end">Votos</th>
                                                        <th style="width: 25%;">% (De Votos)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var item in grupo.OrderByDescending(x => x.CantidadVotos))
                                                    {
                                                        double porcentaje = totalGrupo > 0 ? (double)item.CantidadVotos / totalGrupo * 100 : 0;
                                                        var esGanador = item == grupo.OrderByDescending(x => x.CantidadVotos).First() && item.CantidadVotos > 0;

                                                        <tr class="@(esGanador ? "table-success border-start border-5 border-success" : "")">
                                                            <td>
                                                                <div class="d-flex align-items-center">
                                                                    @if (!string.IsNullOrEmpty(item.FotoUrl))
                                                                    {
                                                                        <img src="@item.FotoUrl" class="rounded-circle me-2 candidate-img" />
                                                                    }
                                                                    <div>
                                                                        <span class="fw-bold d-block">@item.Candidato</span>
                                                                        @if (esGanador)
                                                                        {
                                                                            <span class="badge bg-warning text-dark shadow-sm">🏆 Ganador</span>
                                                                        }
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td><span class="badge bg-secondary">@item.Partido</span></td>
                                                            <td class="text-end fw-bold fs-5">@item.CantidadVotos.ToString("N0")</td>
                                                            <td>
                                                                <div class="d-flex align-items-center">
                                                                    <div class="progress flex-grow-1" style="height: 20px;">
                                                                        <div class="progress-bar @(esGanador ? "bg-success" : "bg-primary")"
                                                                             role="progressbar"
                                                                             style="width: @porcentaje.ToString("0")%;">
                                                                        </div>
                                                                    </div>
                                                                    <span class="ms-2 small fw-bold">@porcentaje.ToString("0.0")%</span>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                            <div class="text-end text-muted small mt-2">
                                                * Nota: La tabla muestra porcentajes sobre votos válidos. La gráfica incluye el ausentismo.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    esPrimero = false;
                }

                <div class="tab-pane fade" id="content-general" role="tabpanel">
                    <div class="alert alert-info text-center">
                        <h4 class="alert-heading">🌍 Panorama General</h4>
                        <p class="mb-0">Resumen incluyendo el nivel de ausentismo por dignidad.</p>
                    </div>
                    <div class="row">
                        @foreach (var grupo in grupos)
                        {
                            var nombreDignidad = grupo.Key ?? "Otros";
                            <div class="col-md-6 mb-4">
                                <div class="card h-100 shadow-sm border-0">
                                    <div class="card-header text-center fw-bold bg-light">@nombreDignidad</div>
                                    <div class="card-body">
                                        <div style="height: 250px;">
                                            <canvas id="mini-chart-@nombreDignidad.Replace(" ", "")"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

            </div>
        }
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="~/lib/jquery/dist/jquery.min.js"></script>

<script>
    var selProv = '@ViewBag.ProvinciaId';
    var selCant = '@ViewBag.CantonId';
    var selParr = '@ViewBag.ParroquiaId';

    $(document).ready(function () {
        if (selProv) cargarCantones(selProv, selCant);

        $("#provinciaId").change(function () {
            var id = $(this).val();
            $("#cantonId").empty().append('<option value="">-- Todos --</option>').prop('disabled', true);
            $("#parroquiaId").empty().append('<option value="">-- Todas --</option>').prop('disabled', true);
            if (id) cargarCantones(id, null);
        });

        $("#cantonId").change(function () {
            var id = $(this).val();
            $("#parroquiaId").empty().append('<option value="">-- Todas --</option>').prop('disabled', true);
            if (id) cargarParroquias(id, null);
        });

        inicializarGraficasAgrupadas();
    });

    function cargarCantones(provId, valorSeleccionado) {
        $.getJSON('/Geografia/ObtenerCantones?provinciaId=' + provId, function (data) {
            var combo = $("#cantonId");
            combo.empty().append('<option value="">-- Todos --</option>');
            $.each(data, function (i, item) {
                combo.append($('<option>').val(item.id).text(item.nombre));
            });
            combo.prop('disabled', false);
            if (valorSeleccionado) {
                combo.val(valorSeleccionado);
                cargarParroquias(valorSeleccionado, selParr);
            }
        });
    }

    function cargarParroquias(cantId, valorSeleccionado) {
        $.getJSON('/Geografia/ObtenerParroquias?cantonId=' + cantId, function (data) {
            var combo = $("#parroquiaId");
            combo.empty().append('<option value="">-- Todas --</option>');
            $.each(data, function (i, item) {
                combo.append($('<option>').val(item.id).text(item.nombre));
            });
            combo.prop('disabled', false);
            if (valorSeleccionado) combo.val(valorSeleccionado);
        });
    }

    function generarPDF() {
        var element = document.getElementById('area-impresion');
        var opt = {
            margin: 0.2,
            filename: 'Reporte_Electoral.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
        };
        html2pdf().set(opt).from(element).save();
    }

    // --- GRÁFICAS CON AUSENTISMO ---
    function inicializarGraficasAgrupadas() {
        var datos = @Html.Raw(Json.Serialize(Model?.Resultados));
        // Capturamos el ausentismo del servidor. Si es null, ponemos 0.
        var ausentismo = @(Model?.Ausentismo ?? 0);

        if (!datos) return;

        var gruposDignidad = {};
        datos.forEach(d => {
            var k = d.dignidad || "Otros";
            if (!gruposDignidad[k]) gruposDignidad[k] = [];
            gruposDignidad[k].push(d);
        });

        // Colores: Los primeros para partidos, el último (gris) reservado para Ausentismo
        var coloresBase = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF', '#20c997', '#dc3545'];
        var colorAusentismo = '#6c757d'; // Gris oscuro Bootstrap

        for (const [dignidad, candidatos] of Object.entries(gruposDignidad)) {
            var keyLimpia = dignidad.replace(/ /g, "");

            // 1. Agrupar votos por Partido
            var votosPorPartido = {};
            candidatos.forEach(c => {
                var nombrePartido = c.partido || "Independiente";
                if (!votosPorPartido[nombrePartido]) votosPorPartido[nombrePartido] = 0;
                votosPorPartido[nombrePartido] += c.cantidadVotos;
            });

            var etiquetasChart = Object.keys(votosPorPartido);
            var datosChart = Object.values(votosPorPartido);

            // Clonamos los colores base para esta gráfica
            var coloresChart = [...coloresBase];

            // 2. AGREGAR AUSENTISMO AL GRÁFICO
            if (ausentismo > 0) {
                etiquetasChart.push("Ausentismo (No votaron)");
                datosChart.push(ausentismo);
                // Aseguramos que el último dato tenga el color gris
                // Si hay muchos partidos, empujamos el color al final
                if (datosChart.length > coloresChart.length) {
                    coloresChart.push(colorAusentismo);
                } else {
                    coloresChart[datosChart.length - 1] = colorAusentismo;
                }
            }

            // Crear Charts
            crearChart("chart-" + keyLimpia, etiquetasChart, datosChart, coloresChart, 'doughnut', true);
            crearChart("mini-chart-" + keyLimpia, etiquetasChart, datosChart, coloresChart, 'pie', false);
        }

        function crearChart(canvasId, labels, data, colors, tipo, mostrarLeyenda) {
            var ctx = document.getElementById(canvasId);
            if (ctx) {
                new Chart(ctx, {
                    type: tipo,
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: mostrarLeyenda,
                                position: 'bottom',
                                labels: { boxWidth: 12, padding: 15 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        var label = context.label || '';
                                        var value = context.raw || 0;
                                        // El total aquí incluye votos + ausentismo (Padrón total)
                                        var total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        var percentage = total > 0 ? Math.round((value / total) * 100) + '%' : '0%';
                                        return label + ': ' + value + ' (' + percentage + ')';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
    }
</script>